---
title: "Introduction to r2dii.match"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The package r2dii.match helps you to match counterparties from a loanbook to companies in a physical-asset database. Each section below shows you how.

## Setup

We use the package r2dii.match to access the most important functions you'll learn about. We also use example datasets from the package r2dii.dataraw, and optional but convenient functions from the packages dplyr and readr.

```{r}
library(r2dii.match)
library(r2dii.dataraw)
library(dplyr)
library(readr)
```

## Format input data [loanbook](https://2degreesinvesting.github.io/r2dii.dataraw/reference/loanbook_description.html) and [asset-level data (ald)](https://2degreesinvesting.github.io/r2dii.dataraw/reference/ald_description.html)

We need two datasets: a "loanbook" and an "asset-level dataset" (ald). These should be formatted like:  [`loanbook_demo`](https://2degreesinvesting.github.io/r2dii.dataraw/reference/loanbook_demo.html) and [`ald_demo`](https://2degreesinvesting.github.io/r2dii.dataraw/reference/ald_demo.html) (from the [r2dii.dataraw package](https://2degreesinvesting.github.io/r2dii.dataraw)).

(A note on sector classification: Matches are preferred when the sector from the `loanbook` matches the sector from the `ald`. The `loanbook` sector is determined internally using the `sector_classification_system` and `sector_classification_direct_loantaker` columns. Currently, `sector_classification_system` must be either `ISIC` or `NACE`. If you would like to use a different classification system, please raise an issue in [r2dii.dataraw](https://github.com/2DegreesInvesting/r2dii.dataraw) and we can incorporate it.)

```{r}
loanbook_demo

ald_demo
```

If you want to use `loanbook_demo` and `ald_demo` as template to create your own datasets, do this:

* Write _loanbook\_demo.csv_ and _ald\_demo.csv_ with:

```r
# Writting to current working directory 
loanbook_demo %>% 
  write_csv(path = "loanbook_demo.csv")

ald_demo %>% 
  write_csv(path = "ald_demo.csv")
```

* For each dataset, replace our demo data with your data.
* Save each dataset as, for example, _your\_loanbook.csv_ and _your\_ald.csv_.
* Read your datasets back into R with:

```r
# Reading from current working directory 
your_loanbook <- read_csv("your_loanbook.csv")
your_ald <- read_csv("your_ald.csv")
```

Here we continue to use the `*_demo` datasets, pretending they contain the data of your own.

```{r}
# WARNING: Skip this to avoid overwriting your data with our demo data
your_loanbook <- loanbook_demo
your_ald <- ald_demo
```

## Score the goodness of the match between the loanbook and ald datasets

`match_name()` scores the match between names in a loanbook dataset (lbk) and names in an asset-level dataset (ald). The names come from the columns `name_direct_loantaker`, `name_intermediate_parent_*` and `name_ultimate_parent` of the loanbook dataset, and from the column `name_company` of the a asset-level dataset. There can be any number of `name_intermediate_parent_*` columns, where `*` indicates the level up the corporate tree from `direct_loantaker`. 

The raw names are internally transformed applying best-practices commonly used in name matching algorithms, such as:

* Remove special characters.
* Replace language specific characters.
* Abbreviate certain names to reduce their importance in the matching.
* Removing corporate suffixes when necessary.
* Spell out numbers to increase their importance.

The similarity is then scored between the internally-transformed names of the loanbook against the ald. (For more information on the scoring algorithm used, see: `stringdist::stringsim()`).

```{r}
match_name(your_loanbook, your_ald)
```

`match_name()` defaults to scoring matches between name strings that belong to the same sector. Using `by_sector = FALSE` removes this limitation -- increasing computation time, and the number of potentially incorrect matches to manually validate.

```{r}
match_name(your_loanbook, your_ald, by_sector = FALSE) %>% 
  nrow()

# Compare
match_name(your_loanbook, your_ald, by_sector = TRUE) %>% 
  nrow()
```
