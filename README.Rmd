---
output: github_document 
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# <img src="https://i.imgur.com/3jITMq8.png" align="right" height=40 /> Match loanbook with asset level data

<!-- badges: start -->
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/r2dii.match)](https://CRAN.R-project.org/package=r2dii.match)
[![Travis build status](https://travis-ci.org/2DegreesInvesting/r2dii.match.svg?branch=master)](https://travis-ci.org/2DegreesInvesting/r2dii.match)
[![Coveralls test coverage](https://coveralls.io/repos/github/2DegreesInvesting/r2dii.match/badge.svg)](https://coveralls.io/r/2DegreesInvesting/r2dii.match?branch=master)
<!-- badges: end -->

The goal of r2dii.match is to match loanbook data with asset level data.

## Installation

Install the development version of r2dii.match with something like this:

```r
# install.packages("devtools")

# To install from a private repo, see ?usethis::browse_github_token()
devtools::install_github("2DegreesInvesting/r2dii.match", auth_token = "abc")
```

## Example

```{r}
library(r2dii.match)
library(r2dii.dataraw)

# An example of the entire matching process
# load up a fake loanbook
a_loanbook <- r2dii.dataraw::loanbook_demo

# load up a fake asset level dataset
fake_asset_level_data <- r2dii.dataraw::ald_demo

# adjust loanbooks with faulty ids
loanbook_adjusted_id <- id_by_loantaker_sector(a_loanbook)

# bridge the loanbook's sector classification codes to our sector classification scheme
bridged_loanbook <- bridge_sector(loanbook_adjusted_id)

# example of how customer names are simplified
# see ?r2dii.match::replace_customer_name for examples on how to add further abbreviations/ rules
some_customer_names <- c("3M Company", "Abbott Laboratories", "AbbVie Inc.")
replace_customer_name(some_customer_names)

# manual input to overwrite certain names and sectors in the loanbook, prior to matching
overwrite_demo <- r2dii.dataraw::overwrite_demo

# prepare loanbook to be matched
prepared_loanbook <- prepare_loanbook_for_matching(loanbook_adjusted_id)

# prepare ALD to be matched
prepared_ald <- prepare_ald_for_matching(fake_asset_level_data)

# run matching (by sector)
match_all_against_all(prepared_loanbook, prepared_ald) %>%
  dplyr::left_join(out, x, by = c("simpler_name_x" = "simpler_name"))

# set threshold
threshold = 0.9

match_all_against_all(prepared_loanbook, prepared_ald) %>%
  dplyr::left_join(prepared_loanbook, by = c("simpler_name_x" = "simpler_name")) %>%
  dplyr::filter(score >= threshold)

```

