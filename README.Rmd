---
output: github_document 
---
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```

# <img src="https://i.imgur.com/3jITMq8.png" align="right" height=40 /> Match loanbook with asset level data

<!-- badges: start -->
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/r2dii.match)](https://CRAN.R-project.org/package=r2dii.match)
[![Travis build status](https://travis-ci.org/2DegreesInvesting/r2dii.match.svg?branch=master)](https://travis-ci.org/2DegreesInvesting/r2dii.match)
[![Coveralls test coverage](https://coveralls.io/repos/github/2DegreesInvesting/r2dii.match/badge.svg)](https://coveralls.io/r/2DegreesInvesting/r2dii.match?branch=master)
<!-- badges: end -->

The goal of r2dii.match is to match generic loanbook data with physical asset level data (ald).

## Installation

Install the development version of r2dii.match from GitHub with:

```r
# install.packages("devtools")
devtools::install_github("2DegreesInvesting/r2dii.match")
```

## Example

As usual, we start by using required packages. For general purpose functions we'll also use dplyr.

```{r}
library(r2dii.match)
library(r2dii.dataraw)
library(dplyr)
```

Before matching, you must first prepare both a loanbook and asset-level dataset, structured just like the example datasets `loanbook_demo` and `ald_demo`.

```{r}
loanbook_demo

ald_demo
```

You may write our example datasets into a .csv file and use them as a template to prepare your own data.

```r
loanbook_demo %>% 
  readr::write_csv(path = "loanbook_template.csv")

ald_demo %>% 
  readr::write_csv(path = "ald_template.csv")
```

If you edit _loanbook_template.csv_ and _ald_template.csv_, and save them into the files _your_loanbook.csv_ and _your_ald.csv_, you can then read them back into R with:

```r
your_loanbook <- readr::read_csv("your_loanbook.csv")
your_ald <- readr::read_csv("your_ald.csv")
```

Here we'll continue to work with the `_demo` datasets.

`prepare_loanbook_for_matching()` does a lot of things. For example, it adds the column `simpler_name`, a modified version of the `name` column after applying best practices commonly used in name matching algorithms, such as:

* Remove special characters.
* Replace language specific characters.
* Abbreviate certain names to reduce their importance in the matching.
* Spell out numbers to increase their importance.

```{r}
loanbook <- loanbook_demo %>% 
  prepare_loanbook_for_matching() %>% 
  # `simpler_name` and `name` move to the left, for clarity
  select(simpler_name, name, everything())
loanbook

ald <- ald_demo %>% 
  prepare_ald_for_matching() %>% 
  select(simpler_name, name, everything())
ald
```

`match_all_against_all()` scores the similarity between `simpler_name` values in the prepared loanbook and ald datasets. 

```{r}
matched_by_sector <- match_all_against_all(loanbook, ald)

matched_by_sector
```

By default, names are compared against ald names in the same sector. `by_sector = FALSE` increases the matching runtime on large datasets, and the amount of nonsensical matches. 

```{r}
match_all_against_all(
  loanbook, ald, 
  by_sector = FALSE
)
```

You can recover the `sector` column from the `loanbook` and `ald` dataset with `dplyr::left_join()`:

```{r}
matched_by_sector %>% 
  left_join(loanbook, by = c("simpler_name_x" = "simpler_name"))
```

You can also recover the `sector` column from the `ald` dataset with a similar strategy:

```{r}
matched_by_sector %>% 
  left_join(loanbook, by = c("simpler_name_x" = "simpler_name")) %>%
  dplyr::rename(sector_x = sector) %>%
  left_join(ald, by = c("simpler_name_y" = "simpler_name")) %>%
  dplyr::rename(sector_y = sector)
```

You may pick rows at and above some score with `dplyr::fileter()`:

```{r}
threshold <- 0.5
matched_by_sector %>%
  dplyr::filter(score >= threshold)
```

You may save the matched dataset with something like:

```r
readr::write_csv(matched, "path/to/save/matches_to_be_verified.csv")
```

You should verify and edit the data manually, e.g. with MS Excel or Google Sheets:

Compare `simpler_name_x` and `simpler_name_y` manually, along with the loanbook sector. If you are happy with the match, set the `score` value to `1` (only values of exactly `1` will be considered valid).

You may then re-read the validated data with:

```r
readr::read_csv("path/to/load/verified_matches.csv")
```

**Work in progress, next step of analysis it to join in validated matches in order of priority**. 
